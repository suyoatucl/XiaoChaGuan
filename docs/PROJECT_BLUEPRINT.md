# 小查馆（XiaoChaGuan）项目蓝图

> AI-Powered Multilingual Fact-Checking Browser Extension for Censorship-Restricted Environments

---

## 一、项目概述

### 1.1 问题陈述

中国大陆自媒体频繁对非中文/非英语信源进行翻译篡改或曲解，而受众因 GFW（防火长城）限制无法访问原始平台进行事实核查。这导致：

- 误译信息在社交媒体上广泛传播
- 用户缺乏验证外文来源的工具和渠道
- 信息不对称加剧了虚假信息的扩散

### 1.2 解决方案

小查馆（XiaoChaGuan）是一个基于 AI 的多语种事实核查浏览器扩展，专为受限网络环境设计。通过 RAG（检索增强生成）架构、多层网络规避策略和本地优先的缓存机制，为用户提供可靠的跨语言事实验证服务。

### 1.3 目标用户

- 中国大陆社交媒体用户（微博、微信、知乎、抖音、小红书）
- 关注国际新闻但受网络限制的读者
- 新闻从业者和内容审核人员
- 学术研究人员

### 1.4 产品形态

| 组件 | 描述 |
|------|------|
| Chrome/Edge 扩展 | 主产品，提供实时页面分析和验证功能 |
| 配套网站 | xiaochaguan.app，提供独立验证入口和 API 文档 |
| 后端 API | FastAPI 服务，处理 RAG 检索和 LLM 分析 |

---

## 二、核心功能

### 2.1 功能矩阵

| 功能模块 | 描述 | 优先级 |
|---------|------|--------|
| **被动检测** | 浏览时自动识别页面中的可疑声明并高亮标记 | P0 |
| **主动查询** | 选中文本 → 右键验证 → 显示多源验证结果 | P0 |
| **跨语言验证** | 检测翻译内容，自动查找原文并对比差异 | P0 |
| **离线/受限模式** | 网络受限时使用本地缓存，网络恢复后后台更新 | P1 |
| **多层网络规避** | Shadowsocks → VMess → Tor → CDN 自动故障转移 | P1 |
| **验证历史** | 本地存储验证记录，支持搜索和导出 | P2 |
| **统计面板** | 展示验证次数、准确率、常见误信息类型 | P2 |

### 2.2 用户场景

**场景 A：被动检测（日常浏览）**
```
用户浏览微博 → 插件自动检测可疑内容 → 高亮显示 → 悬停查看快速结果 → 点击查看详细证据
```

**场景 B：主动查询（有疑问时）**
```
看到可疑信息 → 选中文本 → 右键验证 → 显示验证进度 → 展示多源结果和置信度
```

**场景 C：离线模式（网络受限）**
```
检测网络受限 → 自动切换本地模式 → 使用缓存数据 → 标记可能过时 → 网络恢复后更新
```

**场景 D：跨语言验证（外文翻译内容）**
```
检测翻译痕迹 → 自动查找原文来源 → 对比原文与翻译差异 → 标注误译部分
```

### 2.3 支持的语言（10+）

| 语言 | 代码 | 优先级 |
|------|------|--------|
| 简体中文 | zh-CN | P0 |
| 繁体中文 | zh-TW | P0 |
| 英语 | en | P0 |
| 日语 | ja | P1 |
| 韩语 | ko | P1 |
| 俄语 | ru | P1 |
| 德语 | de | P2 |
| 法语 | fr | P2 |
| 西班牙语 | es | P2 |
| 阿拉伯语 | ar | P2 |
| 葡萄牙语 | pt | P2 |

---

## 三、技术架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户层                                   │
│  ┌─────────────────┐              ┌─────────────────────────┐   │
│  │ Chrome Extension │              │     Web App             │   │
│  │ (Svelte/Plasmo)  │              │   (React/TypeScript)    │   │
│  └────────┬────────┘              └───────────┬─────────────┘   │
└───────────┼────────────────────────────────────┼─────────────────┘
            │                                    │
            v                                    v
┌─────────────────────────────────────────────────────────────────┐
│                       网络规避层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │Shadowsocks│→ │  VMess   │→ │   Tor    │→ │   CDN    │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              v
┌─────────────────────────────────────────────────────────────────┐
│                        API 层 (FastAPI)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ /api/verify │  │ /api/search │  │ /api/cache  │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          v                v                v
┌─────────────────────────────────────────────────────────────────┐
│                       RAG Pipeline                              │
│                                                                 │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐    │
│  │ 声明提取  │ → │ 向量嵌入  │ → │ 多源检索  │ → │ LLM 分析  │    │
│  │ (jieba)  │   │(s-trans) │   │(Pinecone)│   │(Claude)  │    │
│  └──────────┘   └──────────┘   └──────────┘   └──────────┘    │
└─────────────────────────────────────────────────────────────────┘
          │                │                │
          v                v                v
┌─────────────────────────────────────────────────────────────────┐
│                        数据层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  Pinecone   │  │    Redis    │  │  IndexedDB  │             │
│  │ (向量存储)   │  │  (缓存)     │  │ (本地存储)   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 技术栈详情

#### 前端 - Chrome Extension

| 技术 | 用途 | 版本 |
|------|------|------|
| TypeScript | 主要开发语言 | ^5.3 |
| Svelte | UI 框架 | ^4.2 |
| Plasmo | 扩展开发框架 | ^0.84 |
| Tailwind CSS | 样式框架 | ^3.4 |
| IndexedDB (Dexie.js) | 本地数据存储 | ^3.2 |
| @plasmohq/messaging | 扩展消息通信 | ^0.6 |
| @plasmohq/storage | 扩展存储管理 | ^1.9 |

#### 前端 - Web App

| 技术 | 用途 | 版本 |
|------|------|------|
| TypeScript | 主要开发语言 | ^5.3 |
| React | UI 框架 | ^18.2 |
| Vite | 构建工具 | ^5.0 |
| TanStack Query | 数据获取 | ^5.0 |
| Zustand | 状态管理 | ^4.4 |

#### 后端 - API Service

| 技术 | 用途 | 版本 |
|------|------|------|
| Python | 主要开发语言 | ^3.11 |
| FastAPI | Web 框架 | ^0.109 |
| Pydantic | 数据验证 | ^2.5 |
| uvicorn | ASGI 服务器 | ^0.27 |
| httpx | 异步 HTTP 客户端 | ^0.26 |

#### NLP/AI

| 技术 | 用途 | 版本/模型 |
|------|------|----------|
| jieba | 中文分词 | ^0.42 |
| sentence-transformers | 文本嵌入 | paraphrase-multilingual-MiniLM-L12-v2 |
| Claude API | LLM 分析 | claude-3-opus / claude-3-sonnet |
| OpenAI API | 备用 LLM | gpt-4-turbo |
| LangChain | RAG 编排（可选） | ^0.1 |

#### 数据存储

| 技术 | 用途 | 部署方式 |
|------|------|---------|
| Pinecone | 向量数据库 | Cloud |
| Redis | 缓存层 | Docker / Cloud |
| IndexedDB | 客户端本地存储 | 浏览器内置 |

#### 网络规避

| 协议 | 优先级 | 用途 |
|------|--------|------|
| Shadowsocks | 主要 | 加密代理 |
| VMess (V2Ray) | 备用 | 协议混淆 |
| Tor + Snowflake | 最后手段 | 抗审查 |
| CDN 代理 | 补充 | 利用 CDN 转发 |

#### 部署

| 技术 | 用途 |
|------|------|
| Docker | 容器化 |
| docker-compose | 本地编排 |
| GitHub Actions | CI/CD |
| Cloudflare Pages | 静态网站托管 |
| AWS/GCP | 后端服务托管 |

---

## 四、RAG 架构详解

### 4.1 Pipeline 流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     RAG Verification Pipeline                   │
└─────────────────────────────────────────────────────────────────┘

Step 1: 输入处理
┌─────────────┐
│ 用户输入     │  "某自媒体称：日本政府宣布将于2024年禁止所有外国游客入境"
│ (待验证文本) │
└──────┬──────┘
       │
       v
Step 2: 声明提取 (Claim Extraction)
┌─────────────────────────────────────────────────────────────────┐
│ jieba 分词 + 规则引擎 + LLM 辅助                                  │
│                                                                 │
│ 输出：                                                           │
│ - claim: "日本政府将于2024年禁止所有外国游客入境"                   │
│ - entities: ["日本政府", "2024年", "外国游客", "入境禁令"]          │
│ - claim_type: "政策声明"                                         │
│ - language: "zh-CN"                                             │
└──────┬──────────────────────────────────────────────────────────┘
       │
       v
Step 3: 语言检测与翻译
┌─────────────────────────────────────────────────────────────────┐
│ 检测原文可能的语言来源                                            │
│                                                                 │
│ - 检测到关键词"日本" → 可能有日语原始来源                          │
│ - 生成多语言查询：                                                │
│   - zh: "日本 禁止 外国游客 2024"                                 │
│   - en: "Japan ban foreign tourists 2024"                       │
│   - ja: "日本 外国人観光客 禁止 2024"                              │
└──────┬──────────────────────────────────────────────────────────┘
       │
       v
Step 4: 向量嵌入 (Embedding)
┌─────────────────────────────────────────────────────────────────┐
│ sentence-transformers (paraphrase-multilingual-MiniLM-L12-v2)   │
│                                                                 │
│ 将查询文本转换为 384 维向量                                        │
│ 支持 50+ 语言的跨语言语义匹配                                      │
└──────┬──────────────────────────────────────────────────────────┘
       │
       v
Step 5: 多源检索 (Multi-Source Retrieval)
┌─────────────────────────────────────────────────────────────────┐
│ 并行检索多个数据源：                                              │
│                                                                 │
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│ │   Pinecone   │  │  News APIs   │  │  Wikipedia   │           │
│ │  (向量检索)   │  │  (关键词)    │  │   (实体)     │           │
│ └──────────────┘  └──────────────┘  └──────────────┘           │
│                                                                 │
│ 数据源优先级：                                                    │
│ 1. 官方来源（政府网站、官方媒体）                                   │
│ 2. 权威媒体（路透社、AP、共同社）                                   │
│ 3. 事实核查机构（Snopes、PolitiFact、辟谣平台）                     │
│ 4. 百科全书（Wikipedia、Britannica）                              │
│ 5. 学术来源（Google Scholar）                                     │
└──────┬──────────────────────────────────────────────────────────┘
       │
       v
Step 6: 证据重排序 (Re-ranking)
┌─────────────────────────────────────────────────────────────────┐
│ 基于相关性、来源可信度、时效性对检索结果排序                         │
│                                                                 │
│ 评分因子：                                                        │
│ - semantic_similarity: 语义相似度 (0-1)                          │
│ - source_credibility: 来源可信度 (0-1)                           │
│ - recency: 时效性 (基于发布时间)                                  │
│ - language_match: 语言匹配度                                     │
└──────┬──────────────────────────────────────────────────────────┘
       │
       v
Step 7: LLM 分析 (Reasoning)
┌─────────────────────────────────────────────────────────────────┐
│ Claude API / GPT-4                                              │
│                                                                 │
│ Prompt 结构：                                                    │
│ - System: 你是一个专业的事实核查助手...                            │
│ - Context: [检索到的证据文档]                                     │
│ - Query: 请验证以下声明的真实性：[原始声明]                         │
│                                                                 │
│ 输出格式 (JSON)：                                                 │
│ {                                                               │
│   "verdict": "false" | "true" | "partly_true" | "unverified",   │
│   "confidence": 0.92,                                           │
│   "summary": "该声明为虚假信息。日本政府从未宣布...",               │
│   "evidence_chain": [...],                                      │
│   "original_source": {...},                                     │
│   "mistranslation_detected": true,                              │
│   "mistranslation_details": "原文实际内容为..."                   │
│ }                                                               │
└──────┬──────────────────────────────────────────────────────────┘
       │
       v
Step 8: 结果输出
┌─────────────────────────────────────────────────────────────────┐
│ 返回结构化验证结果                                                │
│                                                                 │
│ - 验证结论 + 置信度                                               │
│ - 证据链（带来源链接）                                            │
│ - 原文对比（如检测到误译）                                         │
│ - 缓存到 IndexedDB 供离线使用                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 数据流

```
                    ┌─────────────────┐
                    │   用户请求       │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              v              v              v
       ┌──────────┐   ┌──────────┐   ┌──────────┐
       │ IndexedDB │   │  Redis   │   │ Pinecone │
       │ (本地缓存) │   │ (API缓存) │   │ (向量库)  │
       └──────────┘   └──────────┘   └──────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                             v
                    ┌─────────────────┐
                    │  缓存命中？      │
                    └────────┬────────┘
                      Yes    │    No
                    ┌────────┴────────┐
                    v                 v
             ┌──────────┐      ┌──────────┐
             │ 返回缓存  │      │ RAG 检索  │
             └──────────┘      └──────────┘
                                    │
                                    v
                             ┌──────────┐
                             │ LLM 分析  │
                             └──────────┘
                                    │
                                    v
                             ┌──────────┐
                             │ 更新缓存  │
                             └──────────┘
                                    │
                                    v
                             ┌──────────┐
                             │ 返回结果  │
                             └──────────┘
```

---

## 五、网络规避策略

### 5.1 多层连接架构

```
优先级：直连 > Shadowsocks > VMess > Tor > 离线缓存

┌─────────────────────────────────────────────────────────────────┐
│                     Connection Manager                          │
└─────────────────────────────────────────────────────────────────┘

Layer 1: 直连检测
┌─────────────────────────────────────────────────────────────────┐
│ 尝试直接连接 API 端点                                             │
│ - 适用于境外用户或未被封锁的网络                                    │
│ - 超时：3秒                                                      │
│ - 失败 → 进入 Layer 2                                            │
└─────────────────────────────────────────────────────────────────┘
                             │
                             v (失败)
Layer 2: Shadowsocks
┌─────────────────────────────────────────────────────────────────┐
│ 主要规避协议                                                      │
│ - 加密方法：chacha20-ietf-poly1305                               │
│ - 协议混淆：伪装为 HTTPS 流量                                      │
│ - 服务器池：多节点自动切换                                         │
│ - 超时：5秒                                                      │
│ - 失败 → 进入 Layer 3                                            │
└─────────────────────────────────────────────────────────────────┘
                             │
                             v (失败)
Layer 3: VMess (V2Ray)
┌─────────────────────────────────────────────────────────────────┐
│ 备用规避协议                                                      │
│ - WebSocket + TLS 传输                                          │
│ - CDN 中转（利用 Cloudflare 等）                                  │
│ - 超时：8秒                                                      │
│ - 失败 → 进入 Layer 4                                            │
└─────────────────────────────────────────────────────────────────┘
                             │
                             v (失败)
Layer 4: Tor + Snowflake
┌─────────────────────────────────────────────────────────────────┐
│ 最后手段                                                         │
│ - Snowflake 桥接（利用 WebRTC）                                   │
│ - 延迟较高但抗封锁能力强                                           │
│ - 超时：15秒                                                     │
│ - 失败 → 进入离线模式                                             │
└─────────────────────────────────────────────────────────────────┘
                             │
                             v (失败)
Layer 5: 离线模式
┌─────────────────────────────────────────────────────────────────┐
│ 使用本地 IndexedDB 缓存                                           │
│ - 标记结果可能过时                                                │
│ - 后台定期重试连接                                                │
│ - 连接恢复后自动同步                                              │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 连接健康监控

```typescript
interface ConnectionStatus {
  layer: 'direct' | 'shadowsocks' | 'vmess' | 'tor' | 'offline';
  latency: number;       // 毫秒
  lastSuccess: Date;
  failureCount: number;
  isHealthy: boolean;
}
```

---

## 六、缓存策略

### 6.1 多层缓存架构

| 层级 | 存储 | 用途 | TTL |
|------|------|------|-----|
| L1 | 内存 | 当前会话热数据 | 会话结束 |
| L2 | IndexedDB | 客户端持久化 | 7 天 |
| L3 | Redis | 服务端 API 缓存 | 24 小时 |
| L4 | Pinecone | 向量检索结果 | 30 天 |

### 6.2 缓存键设计

```typescript
// 验证结果缓存键
const cacheKey = `verify:${hash(normalizedClaim)}:${language}`;

// 检索结果缓存键
const searchKey = `search:${hash(query)}:${sources.join(',')}`;
```

### 6.3 缓存更新策略

- **Write-through**: 验证结果同时写入 L2 和 L3
- **Stale-while-revalidate**: 返回缓存同时后台更新
- **Cache invalidation**: 基于 TTL + 主动失效

---

## 七、目标指标

### 7.1 技术指标

| 指标 | 目标值 | 测量方式 |
|------|--------|---------|
| 验证准确率 | > 85% | 与专家判断对比 |
| 响应时间（缓存命中） | < 2s | P95 延迟 |
| 响应时间（实时验证） | < 8s | P95 延迟 |
| 缓存命中率 | > 60% | 请求统计 |
| 网络连接成功率 | > 95% | 连接监控 |
| 误报率 | < 8% | 用户反馈 |
| Token 成本优化 | 降低 45% | 通过 context pruning |

### 7.2 用户指标

| 指标 | 目标值 | 测量方式 |
|------|--------|---------|
| 日活用户 (DAU) | > 10K | 匿名统计 |
| 7 日留存率 | > 40% | 活跃追踪 |
| 用户满意度 | > 4.5/5 | 评分反馈 |
| 月验证请求量 | > 100K | 请求计数 |

---

## 八、开发路线图

### Phase 1: MVP (4-6 周)

**目标**: 完成基础可用版本

| 任务 | 优先级 | 预估时间 |
|------|--------|---------|
| 搭建 Plasmo 扩展骨架 | P0 | 3 天 |
| 实现基础 Popup UI | P0 | 5 天 |
| 实现 Content Script 文本提取 | P0 | 4 天 |
| 搭建 FastAPI 后端框架 | P0 | 3 天 |
| 实现简单关键词验证 | P0 | 5 天 |
| IndexedDB 缓存层 | P1 | 4 天 |
| Docker 容器化 | P1 | 2 天 |

### Phase 2: 核心功能 (6-8 周)

**目标**: 完成 RAG 架构和 LLM 集成

| 任务 | 优先级 | 预估时间 |
|------|--------|---------|
| jieba 中文分词集成 | P0 | 3 天 |
| sentence-transformers 嵌入 | P0 | 4 天 |
| Pinecone 向量检索 | P0 | 5 天 |
| Claude API 集成 | P0 | 4 天 |
| RAG Pipeline 完整实现 | P0 | 8 天 |
| 多语言支持 (5+ 语言) | P1 | 6 天 |
| Firefox/Edge 兼容 | P2 | 4 天 |

### Phase 3: 网络优化 (8-10 周)

**目标**: 实现多层网络规避

| 任务 | 优先级 | 预估时间 |
|------|--------|---------|
| Shadowsocks 客户端集成 | P0 | 10 天 |
| 连接管理器实现 | P0 | 6 天 |
| VMess 协议支持 | P1 | 8 天 |
| Tor 桥接集成 | P1 | 6 天 |
| 自动故障转移 | P0 | 5 天 |
| 离线模式完善 | P1 | 4 天 |

### Phase 4: 高级功能 (8-10 周)

**目标**: 提升用户体验和准确率

| 任务 | 优先级 | 预估时间 |
|------|--------|---------|
| 实时页面监控 | P1 | 6 天 |
| 跨语言验证优化 | P0 | 8 天 |
| 误译检测算法 | P0 | 7 天 |
| 扩展至 10+ 语言 | P1 | 5 天 |
| 验证历史管理 | P2 | 4 天 |
| 统计面板 | P2 | 4 天 |
| 用户反馈系统 | P2 | 3 天 |

### Phase 5: 优化与扩展 (4-6 周)

**目标**: 性能优化和安全审计

| 任务 | 优先级 | 预估时间 |
|------|--------|---------|
| 性能优化 | P0 | 6 天 |
| Token 成本优化 | P0 | 4 天 |
| 安全审计 | P0 | 5 天 |
| A/B 测试框架 | P1 | 3 天 |
| 国际化 (i18n) | P2 | 4 天 |
| 文档完善 | P1 | 3 天 |

---

## 九、风险与缓解

### 9.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| GFW 升级封锁 | 高 | 多协议支持、快速更新机制、开源社区协作 |
| LLM API 限流 | 中 | 多模型切换、本地缓存、请求队列 |
| 向量数据库成本 | 中 | 缓存优化、按需扩容、开源替代方案 |

### 9.2 法律风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 开发者法律风险 | 高 | 境外托管、避免中国管辖权 |
| 用户使用风险 | 中 | 清晰风险披露、安装前确认 |

### 9.3 运营风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 可持续性 | 高 | 开源模型、社区支持、基金会资助 |
| 用户获取 | 中 | 多渠道分发、口碑传播 |

---

## 十、隐私与安全

### 10.1 数据最小化原则

- 不收集用户个人身份信息
- 验证请求匿名化处理
- 本地优先存储敏感数据

### 10.2 加密措施

| 数据类型 | 加密方式 |
|---------|---------|
| 网络传输 | TLS 1.3 + 协议混淆 |
| 本地存储 | AES-256-GCM |
| API 通信 | HTTPS + 签名验证 |

### 10.3 用户控制

- 支持完全本地模式
- 一键清除所有数据
- 透明的数据使用说明

---

## 十一、部署架构

### 11.1 Docker Compose 配置

```yaml
version: '3.8'

services:
  api:
    build: ./xiaochaguan-backend
    ports:
      - "8000:8000"
    environment:
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  # 可选：Celery worker 用于异步任务
  worker:
    build: ./xiaochaguan-backend
    command: celery -A app.worker worker --loglevel=info
    environment:
      - REDIS_URL=redis://redis:6379
    depends_on:
      - redis

volumes:
  redis_data:
```

### 11.2 CI/CD Pipeline

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  Push   │ →  │  Test   │ →  │  Build  │ →  │ Deploy  │
│ GitHub  │    │ (Jest)  │    │ (Docker)│    │ (Cloud) │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

---

## 十二、成功标准

项目成功的关键因素：

1. **技术领先**: RAG + LLM 混合架构，验证准确率 > 85%
2. **网络突破**: 多层规避策略，95%+ 可用性
3. **用户友好**: 简洁界面，一键验证，< 2s 响应
4. **隐私保护**: 本地优先，数据最小化
5. **可持续性**: 开源社区，持续迭代

---

*最后更新: 2025-01-29*
